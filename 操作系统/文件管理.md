### 0x00 基本概念

**系统运行时，计算机以进程为基本单位进行资源的调度和分配，在用户进行输入、输出中，则以文件为基本单位**。 文件系统提供了与二级存储相关的资源的抽象，让用户能在不了解文件的各种属性、文件存储介质的特征以及文件在存储介质上的具体位置等情况下，方便快捷地使用文件。

用户**通过文件系统**建立文件，提供应用程序的输入、输出，对资源进行管理。我们通过自底向上的形式来描述文件的结构如下：

* **数据项**：数据项是文件系统中最低级的数据组织形式，分为如下两种类型：
  * **基本数据项**：用于描述一个对象的某种属性的一个值，如姓名、日期或证件号等，**是数据中可命名的最小逻辑数据单位**，即**原子数据**。
  * **组合数据项**：由多个基本数据项组成
* **记录**：记录是**一组相关的数据项的集合**，用于描述**一个对象在某方面的属性**，如一个考生报名记录包括姓名、出生日期、报考学校代号、身份证等一系列域
* **文件**：文件是指**由创建者所定义的一组相关信息的集合**，逻辑上可分为两种：
  * 有结构文件：文件由**一组相似记录**组成，如报考某学校的所有考生的报考信息记录，又称为**记录式文件**
  * 无结构文件：则被看成是一个**字符流**，比如一个二进制文件或字符文件，又称为**流式文件**

文件属于**抽象数据类型**。文件有如下几个基本操作：

* 创建文件
* 写文件
* 读文件
* 删除文件
* **文件重定位**（或**文件寻址**）：按条目搜索目录，将当前文件设置为给定值，并且不会读、写文件
* **截断文件**：文件所有属性不变，并删除文件内容，将其长度置为0并释放空间

每个打开的文件都有如下关联信息：

* **文件指针**：系统跟踪**上次读写位置**作为当前文件位置指针，这种指针对打开文件的某个进程来说是唯一的，因此必须与磁盘文件属性分开保存
* **文件打开计数器**：文件关闭时，操作系统必须重用其打开文件表条目，否则表内空间不够用。因为多个进程可能打开同一个文件，所以系统在删除打开文件条目之前，必须等待最后一个进程关闭文件，该计数器跟踪打开和关闭的数量，当该计数为0时，**系统关闭文件，删除该条目**。
* **文件磁盘位置**：绝大多数文件操作都要求系统修改文件数据，**该信息保存在内存中，以免每个操作都从磁盘中读取**
* **访问权限**：每个进程打开文件都需要有一个访问模式（创建、只读、读写、添加等），**该信息保存在进程的打开文件表中**，以便操作系统能允许或拒绝之后的I/O请求

对于一个文件的访问**常由用户访问权限和文件属性共同限制**。

**读取一个文件的过程**

* 首先用open系统调用打开文件，open的参数中包含文件的路径名和文件名
* 使用read读取文件，其中read仅使用open所返回的文件描述符，并不使用文件名作为参数，read要求提供三个参数：1.文件描述符，2.缓冲区首址 3.传送的字节数

### 0x01 文件的逻辑结构

文件的逻辑结构是**从用户的观点出发**看到的文件的组织形式，文件的逻辑结构与存储介质特性无关。

#### 0x00 无结构文件

无结构文件是**最简单的文件组织形式**，又称为**流式文件**，无结构文件将数据按**顺序**组织为记录并累积保存，以字节（Byte）为单位，对其中记录的访问只能通过**穷举**的方式。

#### 0x01 有结构文件

有结构文件又称为**记录式文件**，按其组织形式可以进一步分为：

* **顺序文件**：文件中的记录一个接一个地顺序排列，记录通常是定长的。可以**顺序存储**或以**链表**的形式存储，在访问时按照顺序搜索文件，其又分为两种结构：

  * **串结构**：**记录之间的顺序与关键字无关**，比如由时间确定，按照存入时间的先后排列
  * **顺序结构**：**文件中所有记录按关键字顺序排列**

  对记录的批量操作中，**对顺序文件的效率是所有逻辑文件中最高的**，**只有顺序文件可以存储在磁带上**，但是**对顺序文件的查找、修改和增加比较困难**。

* **索引文件**：对变长记录文件只能进行顺序查找，系统开销较大，为此可以建立一张索引表以加快检索速度，**索引表本身是定长记录的顺序文件**。
  ![](https://bucket.shaoqunliu.cn/image/0225.png)

* **索引顺序文件**：将顺序文件中的所有记录分为若干组，为顺序文件建立一张索引表，在索引表中**为每组中的第一个记录建立一个索引项**，其中含有该关键字的值以及指向该记录的指针。
  ![](https://bucket.shaoqunliu.cn/image/0226.png)

* **直接文件或散列文件**：给定记录的键值或通过hash函数转换的键值直接决定记录的物理位置，这种映射结构**没有顺序的特性**。

### 0x02 目录结构

#### 0x00 文件控制块

操作系统为实现目录管理，引入了文件控制块（FCB）这种数据结构。文件控制块是用来存放**控制文件需要的各种信息的数据结构**，以实现“**按名存取**”。FCB的有序集合称为文件目录，**一个FCB就是一个文件目录项**。为了创建一个新文件，系统将分配一个FCB并存放在文件目录中，成为目录项。

FCB主要包含以下信息：

- **基本信息**：如文件名、文件的物理位置、文件的逻辑结构、文件的物理结构等
- **存取控制信息**：如文件存取权限等
- **使用信息**：如文件建立时间、修改时间等

**FCB必需连续存放**。**打开文件的过程即为将该文件的FCB存入内存的活跃文件目录表，而一个文件目录项就是一个FCB。**。

在检索目录文件的过程中，只用到了文件名，仅当找到一个目录项（查找文件名与目录项中文件名匹配）时，才需要从该目录项中读出该文件的物理地址。也就是说，在检索目录时，文件的其他描述信息不会用到，也不需调入内存。因此，有的系统（如UNIX）釆用了**文件名和文件描述信息分开**的方法，**文件描述信息单独形成一个称为索引结点的数据结构**，简称为`i`结点，在文件目录中的**每个目录项仅由文件名和指向该文件所对应的`i`结点的指针构成**。

存放在**磁盘**上的索引结点称为磁盘索引结点，UNIX中的每个文件都有一个唯一的磁盘索引结点，主要包括以下几个方面：

* **文件主标识符**：拥有该文件的个人或小组的标识符
* **文件类型**：包括**普通文件、目录文件或特别文件**
* **文件存取权限**：各类用户对该文件的存取权限
* **文件物理地址**：每个索引结点中含有13个地址项，即`iaddr(0) ~ iaddr(12)`，它们以直接或间接方式给出数据文件所在盘块的编号
* **文件长度**：以字节为单位
* **文件链接计数**：在本文件系统中所有指向该文件的文件名的指针计数
* **文件存取时间**：本文件最近被进程存取的时间、最近被修改的时间以及索引结点最近被修改的时间

文件被打开时，磁盘索引结点复制到内存的索引结点中，以便于使用。在**内存索引结点中又增加了以下内容**：

* **索引结点编号**：用于标识内存索引结点
* **状态**：指示`i`结点**是否上锁或被修改**
* **访问计数**：每当有一进程要访问此`i`结点时，计数加1，访问结束减1
* **逻辑设备号**：文件所属文件系统的逻辑设备号
* **链接指针**：设置分别指向空闲链表和散列队列的指针

在目录层次上所需要进行的操作：

* **搜索**：当用户使用一个文件时，需要搜索目录，以找到该文件的对应目录项
* **创建文件**：当创建一个新文件时，需要在目录中增加一个目录项
* **删除文件**：当删除一个文件时，需要在目录中删除相应的目录项
* **显示目录**：显示目录的内容，如显示该用户目录中的所有文件及属性
* **修改目录**：某些文件属性保存在目录中，因而这些属性的变化需要改变相应的目录项

#### 0x01 单级目录结构

在整个文件系统中**只建立一张目录表**，每个文件占一个目录项，如图：

![](https://bucket.shaoqunliu.cn/image/0227.png)

当访问一个文件时，先按文件名在该目录中查找到相应的FCB，经合法性检查后执行相应的操作。当建立一个新文件时，必须先检索所有目录项以**确保没有重名的情况**，然后在该目录中增设一项，把FCB的全部信息保存在该项中。当删除一个文件时，**先**从该目录中找到该文件的目录项，**回收该文件所占用的存储空间**，**然后再清除该目录项**。单级目录结构实现了**按名存取**，但是存在**查找速度慢**、**文件不允许重名**、不便于文件共享等缺点，而且**不适用于多用户的操作系统**。

#### 0x02 两级目录结构

单级目录很容易造成文件名称的混淆，可以考虑釆用两级方案，将文件目录分成**主文件目录**（Master File Directory, MFD）和**用户文件目录**（User File Directory, UFD）两级，如图：

![](https://bucket.shaoqunliu.cn/image/0228.png)

**主文件目录项记录用户名及相应用户文件目录所在的存储位置。用户文件目录项记录该用户文件的FCB信息**。当某用户欲对其文件进行访问时，只需搜索**该用户对应的UFD**，这既**解决了不同用户文件的重名问题**，也在一定程度上保证了文件的安全。两级目录结构可以解决多用户之间的文件重名问题，文件系统可以在目录上实现访问限制，但是两级目录结构**缺乏灵活性**，**不能对文件分类**。

#### 0x03 多级（树形）目录结构

将两级目录结构的层次关系加以推广，就形成了多级目录结构，即树形目录结构：

![](https://bucket.shaoqunliu.cn/image/0229.png)

用户要访问某个文件时**用文件的路径名标识文件**，文件路径名是个字符串，由从根目录出发到所找文件的通路上的所有目录名与数据文件名用分隔符链接起来而成。**从根目录出发的路径称绝对路径**。当层次较多时，每次从根目录查询浪费时间，于是加入了当前目录，进程对各文件的访问都是相对于当前目录进行的。当用户要访问某个文件时，使用**相对路径**标识文件。

树形目录结构可以**方便地对文件进行分类**，**层次结构清晰**，也能够更有效地进行文件的管理和保护。但是，在树形目录中查找一个文件，**需要按路径名逐级访问中间结点**，这就**增加了磁盘访问次数**，无疑将影响查询速度。

#### 0x04 无环图目录结构

树形目录结构可便于实现文件分类，但不便于实现文件共享，为此**在树形目录结构的基础上增加了一些指向同一结点的有向边**，使整个目录成为一个有向无环图。**引入无环图目录结构是为了实现文件共享**：

![](https://bucket.shaoqunliu.cn/image/0230.png)

当某用户要求删除一个共享结点时，若系统只是简单地将它删除，当另一共享用户需要访问时，却无法找到这个文件而发生错误。为此可以**为每个共享结点设置一个共享计数器**，每当图中增加对该结点的共享链时，计数器加1，每当某用户提出删除该结点时，计数器减1。**仅当共享计数器为0时，才真正删除该结点，否则仅删除请求用户的共享链**。

对于共享文件**仅存在一个真正的文件副本**，方便地实现了文件共享，但也使系统管理变得复杂，**任何改变都会为其他用户所见**。

### 0x03 文件共享

#### 0x00 基于索引结点的共享方式

基于索引结点的共享方式也就是**硬链接**，在树形结构的目录中，当有两个或多个用户要共享一个子目录或文件时，**必须将共享文件或子目录链接到两个或多个用户的目录中**，才能方便地找到该文件：

![](https://bucket.shaoqunliu.cn/image/0231.png)

在这种共享方式中引用索引结点，即诸如文件的物理地址及其他的文件属性等信息，不再是放在目录项中，而是放在索引结点中。在文件目录中只设置文件名及指向相应索引结点的指针。在索引结点中还应有一个链接计数count，用于表示链接到本索引结点（亦即文件） 上的用户目录项的数目。当count=2时，表示有两个用户目录项链接到本文件上，或者说是有两个用户共享此文件。当count=0时，表示没有用户使用该文件，系统将负责删除该文件。

#### 0x01 利用符号链实现文件共享

为使用户B能共享用户A的一个文件F，可以**由系统创建一个LINK类型的新文件**，也取名为F，并将文件F写入用户B的目录中，以实现用户B的目录与文件F的链接，在新文件中只包含被链接文件F的路径名，这样的链接方法被称为符号链接，也称为**软链接**。新文件中的路径名则只被看做是符号链，当用户B要访问被链接的文件F且正要读 LINK类新文件时，操作系统根据新文件中的路径名去读该文件，从而实现了用户B对文件F的共享。

在利用符号链方式实现文件共享时，**只有文件的拥有者才拥有指向其索引结点的指针**。而共享该文件的其他用户则只有该文件的路径名，并不拥有指向其索引结点的指针。这样，也就不会发生在文件主删除一共享文件后留下一悬空指针的情况。当文件的拥有者把一个共享文件删除后，其他用户通过符号链去访问它时，会出现访问失败，于是将符号链删除，此时不会产生任何影响。当然，利用符号链实现文件共享仍然存在问题，例如：一个文件釆用符号链方式共享，当文件拥有者将其删除，而在共享的其他用户使用其符号链接访问该文件之前，又有人在同一路径下创建了另一个具有同样名称的文件，则该符号链将仍然有效，但访问的文件已经改变，从而导致错误。

在符号链的共享方式中，当其他用户读共享文件时，需要根据文件路径名逐个地查找目录，直至找到该文件的索引结点。因此，**每次访问时都可能要多次地读盘**，使得访问文件的开销变大并增加了启动磁盘的频率，因此**硬链接的查找速度要比软链接快**。此外，符号链的索引结点也要耗费一定的磁盘空间。符号链方式有一个很大的优点，即**网络共享只需提供该文件所在机器的网络地址以及该机器中的文件路径即可**。

**硬链接和软链接都是文件系统中的静态共享方法**，在文件系统中还存在着另外的共享需求，即**两个进程同时对同一个文件进行操作**，这样的共享可以称为**动态共享**。